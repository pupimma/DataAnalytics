# ==========================================
# üìã TECH CHALLENGE - FASE 4 (VERS√ÉO PT-BR)
# ==========================================

import pandas as pd
import numpy as np
import joblib
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report

# 1. Carga dos Dados
try:
    df = pd.read_csv('Obesity.csv')
    print("‚úÖ Dados carregados com sucesso!")
except FileNotFoundError:
    print("‚ùå Arquivo 'Obesity.csv' n√£o encontrado.")

# 2. Tratamento de Ru√≠dos (Arredondamento)
# Importante fazer isso ANTES da tradu√ß√£o para garantir a integridade dos n√∫meros
cols_to_round = ['FCVC', 'NCP', 'CH2O', 'FAF', 'TUE']
for col in cols_to_round:
    df[col] = df[col].round().astype(int)

# 3. Tradu√ß√£o do Dataset para Portugu√™s
# Dicion√°rio de tradu√ß√£o de colunas
colunas_pt = {
    'Gender': 'G√™nero', 'Age': 'Idade', 'Height': 'Altura', 'Weight': 'Peso',
    'family_history': 'Hist√≥rico_Familiar', 'FAVC': 'Consumo_Cal√≥rico', 
    'FCVC': 'Consumo_Vegetais', 'NCP': 'Refei√ß√µes_Dia', 'CAEC': 'Comer_Entre_Refei√ß√µes',
    'SMOKE': 'Fumante', 'CH2O': 'Consumo_√Ågua', 'SCC': 'Monitora_Calorias',
    'FAF': 'Atividade_F√≠sica', 'TUE': 'Tempo_Eletr√¥nicos', 'CALC': 'Consumo_√Ålcool',
    'MTRANS': 'Transporte', 'Obesity': 'Diagn√≥stico'
}

df = df.rename(columns=colunas_pt)

# Dicion√°rios de tradu√ß√£o de valores
traducao_valores = {
    # G√™nero
    'Female': 'Feminino', 'Male': 'Masculino',
    # Bin√°rios (Sim/N√£o)
    'yes': 'Sim', 'no': 'N√£o',
    # Frequ√™ncias
    'Sometimes': '√Äs vezes', 'Frequently': 'Frequentemente', 'Always': 'Sempre',
    # Transporte
    'Public_Transportation': 'Transporte P√∫blico', 'Walking': 'Caminhada', 
    'Automobile': 'Autom√≥vel', 'Motorbike': 'Motocicleta', 'Bike': 'Bicicleta',
    # Diagn√≥sticos (Target)
    'Insufficient_Weight': 'Abaixo do Peso',
    'Normal_Weight': 'Peso Normal',
    'Overweight_Level_I': 'Sobrepeso N√≠vel I',
    'Overweight_Level_II': 'Sobrepeso N√≠vel II',
    'Obesity_Type_I': 'Obesidade Tipo I',
    'Obesity_Type_II': 'Obesidade Tipo II',
    'Obesity_Type_III': 'Obesidade Tipo III'
}

# Aplicando a tradu√ß√£o em todo o dataframe
df = df.replace(traducao_valores)

# Remo√ß√£o de duplicatas
df = df.drop_duplicates()

# 4. Engenharia de Atributos (Encoding)
# Mapeamento Manual para Ordinais (Mantendo a hierarquia num√©rica)
mapa_ordinais = {
    'N√£o': 0, '√Äs vezes': 1, 'Frequentemente': 2, 'Sempre': 3,
    'Sim': 1, 'N√£o': 0,
    'Feminino': 0, 'Masculino': 1
}

colunas_map = ['Hist√≥rico_Familiar', 'Consumo_Cal√≥rico', 'Fumante', 'Monitora_Calorias', 
               'Comer_Entre_Refei√ß√µes', 'Consumo_√Ålcool', 'G√™nero']

df_processed = df.copy()
for col in colunas_map:
    df_processed[col] = df_processed[col].map(mapa_ordinais)

# One-Hot Encoding para Transporte (Nominal)
df_processed = pd.get_dummies(df_processed, columns=['Transporte'], drop_first=True)

# Encoding do Alvo (Diagn√≥stico)
le = LabelEncoder()
df_processed['Diagn√≥stico_Encoded'] = le.fit_transform(df_processed['Diagn√≥stico'])

# 5. Treinamento
X = df_processed.drop(['Diagn√≥stico', 'Diagn√≥stico_Encoded'], axis=1)
y = df_processed['Diagn√≥stico_Encoded']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

rf_model = RandomForestClassifier(n_estimators=100, random_state=42)
rf_model.fit(X_train, y_train)

# Valida√ß√£o R√°pida
acc = accuracy_score(y_test, rf_model.predict(X_test))
print(f"Acur√°cia: {acc*100:.2f}%")

# 6. Exporta√ß√£o para o App
artifacts = {
    "model": rf_model,
    "label_encoder": le,
    "features": X.columns.tolist()
}

joblib.dump(artifacts, 'modelo_obesidade.pkl')
print("‚úÖ Arquivo 'modelo_obesidade.pkl' gerado com sucesso (em Portugu√™s)!")